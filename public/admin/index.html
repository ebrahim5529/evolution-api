<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolution SaaS - لوحة الإدارة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="app">
        <div id="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mx-auto mb-4"></div>
                <p class="text-gray-400">جاري التحميل...</p>
            </div>
        </div>

        <div id="admin-panel" class="hidden">
            <nav class="bg-black/30 border-b border-white/10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <img src="/images/evolution-logo.png" alt="Evolution API" class="h-8 w-auto">
                            <span class="mr-3 text-xl font-bold text-purple-400">لوحة الإدارة</span>
                        </div>
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <a href="/dashboard" class="text-gray-300 hover:text-white transition">لوحة التحكم</a>
                            <a href="/api/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm transition">
                                تسجيل الخروج
                            </a>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card rounded-xl p-6">
                        <p class="text-gray-400 text-sm">إجمالي المستخدمين</p>
                        <p id="total-users" class="text-3xl font-bold text-purple-400">0</p>
                    </div>
                    <div class="card rounded-xl p-6">
                        <p class="text-gray-400 text-sm">إجمالي الأجهزة</p>
                        <p id="total-instances" class="text-3xl font-bold text-emerald-400">0</p>
                    </div>
                    <div class="card rounded-xl p-6">
                        <p class="text-gray-400 text-sm">الأجهزة المتصلة</p>
                        <p id="active-instances" class="text-3xl font-bold text-blue-400">0</p>
                    </div>
                    <div class="card rounded-xl p-6">
                        <p class="text-gray-400 text-sm">اشتراكات Pro</p>
                        <p id="pro-subscriptions" class="text-3xl font-bold text-yellow-400">0</p>
                    </div>
                </div>

                <div class="card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-6">إدارة المستخدمين</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-gray-400 text-sm border-b border-white/10">
                                    <th class="text-right py-3 px-4">المستخدم</th>
                                    <th class="text-right py-3 px-4">البريد الإلكتروني</th>
                                    <th class="text-right py-3 px-4">الدور</th>
                                    <th class="text-right py-3 px-4">الخطة</th>
                                    <th class="text-right py-3 px-4">الأجهزة</th>
                                    <th class="text-right py-3 px-4">تاريخ التسجيل</th>
                                    <th class="text-right py-3 px-4">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="forbidden" class="hidden flex items-center justify-center min-h-screen">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-red-500 mb-4">غير مصرح</h1>
                <p class="text-gray-400 mb-6">ليس لديك صلاحية للوصول إلى هذه الصفحة</p>
                <a href="/dashboard" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg transition">
                    العودة إلى لوحة التحكم
                </a>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        async function checkAdmin() {
            try {
                const response = await fetch('/api/auth/user');
                if (!response.ok) {
                    window.location.href = '/landing';
                    return;
                }
                currentUser = await response.json();
                
                if (currentUser.role !== 'ADMIN') {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('forbidden').classList.remove('hidden');
                    return;
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadStats();
                loadUsers();
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/landing';
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('total-users').textContent = stats.totalUsers;
                    document.getElementById('total-instances').textContent = stats.totalInstances;
                    document.getElementById('active-instances').textContent = stats.activeInstances;
                    
                    const proCount = stats.subscriptionStats.find(s => s.plan === 'PRO')?._count?.plan || 0;
                    document.getElementById('pro-subscriptions').textContent = proCount;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = users.map(user => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="py-4 px-4">
                        <div class="flex items-center">
                            <img src="${user.profileImageUrl || '/images/evolution-logo.png'}" alt="" class="h-10 w-10 rounded-full ml-3">
                            <div>
                                <p class="font-semibold">${user.firstName || ''} ${user.lastName || ''}</p>
                                <p class="text-sm text-gray-400">${user.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-gray-300">${user.email || '-'}</td>
                    <td class="py-4 px-4">
                        <span class="px-2 py-1 rounded text-xs ${user.role === 'ADMIN' ? 'bg-purple-500/20 text-purple-400' : 'bg-gray-500/20 text-gray-400'}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="py-4 px-4">
                        <span class="px-2 py-1 rounded text-xs ${getSubscriptionClass(user.Subscription?.plan)}">
                            ${user.Subscription?.plan || 'FREE'}
                        </span>
                    </td>
                    <td class="py-4 px-4 text-gray-300">${user.instances?.length || 0}</td>
                    <td class="py-4 px-4 text-gray-300">${new Date(user.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td class="py-4 px-4">
                        <div class="flex space-x-2 space-x-reverse">
                            ${user.role !== 'ADMIN' ? `
                                <button onclick="makeAdmin('${user.id}')" class="text-purple-400 hover:text-purple-300 text-sm">
                                    ترقية لمسؤول
                                </button>
                            ` : `
                                <button onclick="removeAdmin('${user.id}')" class="text-gray-400 hover:text-gray-300 text-sm">
                                    إزالة الإدارة
                                </button>
                            `}
                            <button onclick="deleteUser('${user.id}')" class="text-red-400 hover:text-red-300 text-sm">
                                حذف
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getSubscriptionClass(plan) {
            switch (plan) {
                case 'PRO': return 'bg-yellow-500/20 text-yellow-400';
                case 'BASIC': return 'bg-blue-500/20 text-blue-400';
                default: return 'bg-gray-500/20 text-gray-400';
            }
        }

        async function makeAdmin(userId) {
            if (!confirm('هل أنت متأكد من ترقية هذا المستخدم إلى مسؤول؟')) return;
            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'ADMIN' })
                });
                if (response.ok) {
                    loadUsers();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function removeAdmin(userId) {
            if (!confirm('هل أنت متأكد من إزالة صلاحيات الإدارة؟')) return;
            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'USER' })
                });
                if (response.ok) {
                    loadUsers();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟ سيتم حذف جميع بياناته.')) return;
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    loadUsers();
                    loadStats();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        checkAdmin();
    </script>
</body>
</html>
